{% extends "base.html" %}
{% block title %}Dashboard - {{ guild_id }} - Chad Bot Admin{% endblock %}

{% block content %}
<div class="page-header">
  <h2>Guild Dashboard</h2>
  <p class="page-subtitle">Overview, stats, and configuration for {{ guild_id }}</p>
</div>

<div class="grid grid-cols-3">
  <div class="card">
    <h3>Usage Today</h3>
    <p class="muted">Chat tokens and images roll over daily.</p>
    <div class="stat-item">
      <span class="stat-label">Guild chat tokens</span>
      <span class="stat-value">{{ usage.guild.chat_tokens_used }} / {{ config.global_daily_chat_token_limit }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Guild images</span>
      <span class="stat-value">{{ usage.guild.images_generated }} / {{ config.global_daily_image_limit }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Lifetime tokens</span>
      <span class="stat-value">{{ analytics.token_total }}</span>
    </div>
  </div>
  <div class="card">
    <h3>Analytics</h3>
    <p class="muted">All-time status counts</p>
    <ul class="analytics-list">
      {% for key, value in analytics.status_counts.items() %}
      <li>
        <span class="key">{{ key | replace('_', ' ') | title }}</span>
        <span class="value">{{ value }}</span>
      </li>
      {% endfor %}
      {% if analytics.status_counts|length == 0 %}
      <li class="muted">No data yet.</li>
      {% endif %}
      <li>
        <span class="key">Image Requests</span>
        <span class="value">{{ analytics.image_requests }}</span>
      </li>
    </ul>
  </div>
</div>

<div class="card">
  <form id="config-form">
    <div class="section-header">
      <h3>Configuration</h3>
      <p class="section-description">Edit rates, budgets, and the system prompt.</p>
    </div>

    <section class="form-section">
      <div class="grid grid-cols-2">
        <div class="form-group">
          <label class="toggle">
            <input type="checkbox" name="auto_approve_enabled" {% if config.auto_approve_enabled %}checked{% endif %}>
            <span class="toggle-slider"></span>
            Auto Approve
          </label>
        </div>
        <div class="form-group">
          <label class="toggle">
            <input type="checkbox" name="admin_bypass_auto_approve" {% if config.admin_bypass_auto_approve %}checked{% endif %}>
            <span class="toggle-slider"></span>
            Admins Bypass
          </label>
        </div>
      </div>
    </section>

    <hr class="section-divider">

    <section class="form-section">
      <div class="grid grid-cols-3">
        <div class="form-group">
          <label for="ask_window_seconds">Ask window (s)</label>
          <input type="number" id="ask_window_seconds" name="ask_window_seconds" value="{{ config.ask_window_seconds }}">
        </div>
        <div class="form-group">
          <label for="ask_max_per_window">Ask max / window</label>
          <input type="number" id="ask_max_per_window" name="ask_max_per_window" value="{{ config.ask_max_per_window }}">
        </div>
        <div class="form-group">
          <label for="image_window_seconds">Image window (s)</label>
          <input type="number" id="image_window_seconds" name="image_window_seconds" value="{{ config.image_window_seconds }}">
        </div>
        <div class="form-group">
          <label for="image_max_per_window">Image max / window</label>
          <input type="number" id="image_max_per_window" name="image_max_per_window" value="{{ config.image_max_per_window }}">
        </div>
        <div class="form-group">
          <label for="duplicate_window_seconds">Duplicate window (s)</label>
          <input type="number" id="duplicate_window_seconds" name="duplicate_window_seconds" value="{{ config.duplicate_window_seconds }}">
        </div>
      </div>
    </section>
    
    <hr class="section-divider">

    <section class="form-section">
       <div class="grid grid-cols-2">
        <div class="form-group">
          <label for="user_daily_chat_token_limit">User daily chat tokens</label>
          <input type="number" id="user_daily_chat_token_limit" name="user_daily_chat_token_limit" value="{{ config.user_daily_chat_token_limit }}">
        </div>
        <div class="form-group">
          <label for="global_daily_chat_token_limit">Guild daily chat tokens</label>
          <input type="number" id="global_daily_chat_token_limit" name="global_daily_chat_token_limit" value="{{ config.global_daily_chat_token_limit }}">
        </div>
        <div class="form-group">
          <label for="user_daily_image_limit">User daily images</label>
          <input type="number" id="user_daily_image_limit" name="user_daily_image_limit" value="{{ config.user_daily_image_limit }}">
        </div>
        <div class="form-group">
          <label for="global_daily_image_limit">Guild daily images</label>
          <input type="number" id="global_daily_image_limit" name="global_daily_image_limit" value="{{ config.global_daily_image_limit }}">
        </div>
      </div>
    </section>

    <hr class="section-divider">

    <section class="form-section">
      <div class="grid grid-cols-2">
        <div class="form-group">
          <label for="temperature">Temperature</label>
          <input type="number" id="temperature" step="0.1" name="temperature" value="{{ config.temperature }}">
        </div>
        <div class="form-group">
          <label for="max_completion_tokens">Max completion tokens</label>
          <input type="number" id="max_completion_tokens" name="max_completion_tokens" value="{{ config.max_completion_tokens }}">
        </div>
      </div>
    </section>

    <hr class="section-divider">

    <section class="form-section">
      <div class="form-group">
        <label for="system_prompt">System prompt</label>
        <textarea id="system_prompt" name="system_prompt" rows="4">{{ config.system_prompt }}</textarea>
      </div>
    </section>
    
    <div class="form-actions">
      <button class="btn" type="submit">Save config</button>
      <div id="config-status" class="muted"></div>
    </div>
  </form>
</div>

<div class="card">
  <h3>Pending approval</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Time</th>
        <th>User</th>
        <th>Type</th>
        <th>Preview</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for item in pending %}
      <tr data-id="{{ item.id }}">
        <td>{{ item.created_at }}</td>
        <td>{{ item.user_id }}</td>
        <td>{{ item.command_type }}</td>
        <td>{{ item.user_content[:80] }}</td>
        <td>
          <div class="btn-group">
            <button class="btn success" onclick="approve({{ item.id }}, 'grok')">Approve</button>
            <button class="btn secondary" onclick="manual({{ item.id }})">Manual</button>
            <button class="btn danger" onclick="reject({{ item.id }})">Reject</button>
          </div>
        </td>
      </tr>
      {% endfor %}
      {% if pending|length == 0 %}
      <tr><td colspan="5" class="text-center muted">No pending items.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="card">
  <h3>Recent history</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Time</th>
        <th>User</th>
        <th>Type</th>
        <th>Status</th>
        <th>Prompt</th>
      </tr>
    </thead>
    <tbody>
      {% for row in recent %}
      <tr>
        <td>{{ row.created_at }}</td>
        <td>{{ row.user_id }}</td>
        <td>{{ row.command_type }}</td>
        <td><span class="pill">{{ row.status }}</span></td>
        <td>{{ row.user_content[:120] }}</td>
      </tr>
      {% endfor %}
       {% if recent|length == 0 %}
      <tr><td colspan="5" class="text-center muted">No recent history.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<style>
  .page-header {
    margin-bottom: 2rem; /* 32px */
  }
  .page-header h2 {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem; /* 24px (from Markdown H1) */
    font-weight: 600;
  }
  .page-subtitle {
    margin: 0;
    color: var(--color-text-muted);
  }

  .grid {
    gap: 1.5rem; /* 24px */
  }
  .grid-cols-3 {
    grid-template-columns: repeat(auto-fit, minmax(15.625rem, 1fr)); /* 250px */
  }
  .grid-cols-2 {
    grid-template-columns: repeat(auto-fit, minmax(15.625rem, 1fr)); /* 250px */
  }

  /* Stat Card styles */
  .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--color-border-base);
  }
  .stat-item:last-child {
    border-bottom: none;
  }
  .stat-label {
    font-size: 0.875rem; /* 14px */
    color: var(--color-text-muted);
  }
  .stat-value {
    font-size: 1rem; /* 16px */
    font-weight: 500;
    color: var(--color-text-base);
  }
  .analytics-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .analytics-list li {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
    padding: 0.5rem 0;
  }
  .analytics-list li .key {
    color: var(--color-text-muted);
  }
  .analytics-list li .value {
    font-weight: 500;
  }

  /* Form styles */
  .section-header {
    margin-bottom: 1rem; /* 16px */
  }
  .section-header h3 {
    margin: 0 0 0.25rem 0;
    font-size: 1.125rem; /* 18px */
    font-weight: 600;
  }
  .section-description {
    margin: 0;
    color: var(--color-text-muted);
    font-size: 0.875rem; /* 14px */
  }
  .form-section {
    margin: 1.5rem 0;
  }
  .section-divider {
    margin: 1.5rem 0;
    border: none;
    border-top: 1px solid var(--color-border-base);
  }
  .form-actions {
    display: flex;
    align-items: center;
    gap: 1rem; /* 16px */
    margin-top: 1.5rem; /* 24px */
    padding-top: 1.5rem; /* 24px */
    border-top: 1px solid var(--color-border-base);
  }

  /* Toggles from style.css */
  .toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem; /* 8px */
    cursor: pointer;
    user-select: none;
    font-weight: 500;
  }
  /* Hiding the default checkbox */
  .toggle input[type="checkbox"] {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
  }
  /* Using the slider from style.css */
  .toggle-slider {
    position: relative;
    display: inline-block;
    width: 2.5rem; /* 40px */
    height: 1.25rem; /* 20px */
    background: var(--color-border-interactive);
    transition: 0.2s;
    border-radius: 9999px;
  }
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 0.875rem; /* 14px */
    width: 0.875rem; /* 14px */
    left: 0.1875rem; /* 3px */
    bottom: 0.1875rem; /* 3px */
    background: var(--color-white);
    transition: 0.2s;
    border-radius: 50%;
  }
  input:checked + .toggle-slider {
    background: rgb(var(--color-blue-500) / 1);
  }
  input:checked + .toggle-slider:before {
    transform: translateX(1.25rem); /* 20px */
  }

  /* Table button group */
  .btn-group {
    display: flex;
    gap: 0.5rem; /* 8px */
    flex-wrap: nowrap;
  }

</style>

<script>
const guildId = "{{ guild_id }}";
const adminUserId = localStorage.getItem("adminUserId") || prompt("Enter your Discord user id for admin actions") || "";
if (adminUserId) {
  localStorage.setItem("adminUserId", adminUserId);
}

document.getElementById("config-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const payload = {};
  formData.forEach((value, key) => {
    if (value === "on") {
      payload[key] = true;
    } else if (!isNaN(Number(value)) && value !== "") { // Ensure empty strings aren't cast to 0
      payload[key] = Number(value);
    } else {
      payload[key] = value;
    }
  });
  
  // Explicitly set unchecked checkboxes to false
  payload.auto_approve_enabled = formData.get("auto_approve_enabled") === "on";
  payload.admin_bypass_auto_approve = formData.get("admin_bypass_auto_approve") === "on";
  
  const res = await fetch(`/api/guilds/${guildId}/config`, {
    method: "POST",
    headers: {"Content-Type": "application/json", "X-Discord-User-ID": adminUserId},
    body: JSON.stringify(payload),
  });
  
  const status = document.getElementById("config-status");
  status.textContent = res.ok ? "Saved" : "Error saving config";
  status.style.color = res.ok ? "var(--color-text-success)" : "var(--color-text-danger)";
  setTimeout(() => { status.textContent = ""; }, 3000);
});

async function approve(id, decision) {
  const body = {decision};
  if (decision === "reject") {
    body.reason = prompt("Reason?") || "Request rejected.";
  }
  if (decision === "manual") {
    body.manual_reply_content = prompt("Manual reply") || "Admin reply.";
  }
  const res = await fetch(`/api/approvals/${id}`, {
    method: "POST",
    headers: {"Content-Type": "application/json", "X-Discord-User-ID": adminUserId},
    body: JSON.stringify(body),
  });
  if (res.ok) {
    location.reload();
  } else {
    alert("Failed to update");
  }
}

function reject(id) { approve(id, "reject"); }
function manual(id) { approve(id, "manual"); }
</script>
{% endblock %}