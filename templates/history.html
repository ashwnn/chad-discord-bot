{% extends "base.html" %}
{% block title %}History - Grok Discord Bot Admin{% endblock %}

{% block content %}
<div class="page-header">
  <h2>Message History</h2>
  <p class="page-subtitle">View and search all processed requests</p>
</div>

<div class="card filter-card">
  <h3>Filters</h3>
  <form id="filter-form" class="filter-form">
    <div class="filter-group">
      <label for="status-filter">Status</label>
      <select name="status" id="status-filter">
        <option value="">All Status</option>
        <option value="auto_responded" {% if status_filter == 'auto_responded' %}selected{% endif %}>Auto Responded</option>
        <option value="pending_approval" {% if status_filter == 'pending_approval' %}selected{% endif %}>Pending</option>
        <option value="approved_grok" {% if status_filter == 'approved_grok' %}selected{% endif %}>Approved (Grok)</option>
        <option value="approved_manual" {% if status_filter == 'approved_manual' %}selected{% endif %}>Approved (Manual)</option>
        <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
        <option value="error" {% if status_filter == 'error' %}selected{% endif %}>Error</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label for="command-filter">Type</label>
      <select name="command_type" id="command-filter">
        <option value="">All Types</option>
        <option value="ask" {% if command_type_filter == 'ask' %}selected{% endif %}>Chat (/ask)</option>
      </select>
    </div>
    
    <button type="submit" class="btn btn-filter">Apply Filters</button>
  </form>
</div>

{% if history | length > 0 %}
<div class="card">
  <table class="table history-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>User</th>
        <th>Type</th>
        <th>Status</th>
        <th>Tokens</th>
        <th>Cost</th>
        <th>Content</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for row in history %}
      <tr class="history-row" style="cursor: pointer;" onclick="expandRow(this)">
        <td class="text-sm muted">{{ row.created_at | truncate(16, True, '') }}</td>
        <td class="text-sm">{{ row.user_id }}</td>
        <td>
          {% if row.command_type == 'ask' %}
          <span class="pill">Chat</span>
          {% else %}
          <span class="pill">{{ row.command_type }}</span>
          {% endif %}
        </td>
        <td>
          {% if row.status == 'auto_responded' %}
          <span class="pill">Responded</span>
          {% elif row.status == 'approved_grok' %}
          <span class="pill success">Approved</span>
          {% elif row.status == 'approved_manual' %}
          <span class="pill success">Manual</span>
          {% elif row.status == 'rejected' %}
          <span class="pill danger">Rejected</span>
          {% elif row.status == 'pending_approval' %}
          <span class="pill warning">Pending</span>
          {% elif row.status == 'error' %}
          <span class="pill danger">Error</span>
          {% else %}
          <span class="pill">{{ row.status }}</span>
          {% endif %}
        </td>
        <td class="text-sm">{{ row.total_tokens or '-' }}</td>
        <td class="text-sm">{{ ('$%.4f'|format(row.estimated_cost_usd)) if row.estimated_cost_usd else '-' }}</td>
        <td class="text-sm preview-cell">{{ row.user_content[:60] }}</td>
        <td class="text-sm actions-cell" onclick="event.stopPropagation();">
          {% if not row.deleted_at %}
          <button class="btn-delete" onclick="deleteMessage({{ row.id }})">Delete</button>
          {% else %}
          <span class="text-muted text-sm">Deleted</span>
          {% endif %}
        </td>
      </tr>
      <tr class="details-row" style="display: none;">
        <td colspan="7">
          <div class="details-panel">
            <div class="details-grid">
              <div class="detail-section">
                <h4>Request Content</h4>
                <p class="detail-text">{{ row.user_content }}</p>
              </div>
              {% if row.grok_response_content %}
              <div class="detail-section">
                <h4>Bot Reply</h4>
                <p class="detail-text bot-reply">{{ row.grok_response_content }}</p>
              </div>
              {% endif %}
              <div class="detail-section">
                <h4>Metadata</h4>
                <dl class="detail-list">
                  <dt>Request ID:</dt>
                  <dd>{{ row.id }}</dd>
                  <dt>Status:</dt>
                  <dd>{{ row.status }}</dd>
                  <dt>Decision:</dt>
                  <dd>{{ row.decision or 'N/A' }}</dd>
                  <dt>Tokens Used:</dt>
                  <dd>{{ row.total_tokens or 'N/A' }}</dd>
                </dl>
              </div>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="card empty-state">
  <p class="muted text-center">No history found</p>
</div>
{% endif %}

<script>
document.getElementById("filter-form").addEventListener("submit", (e) => {
  e.preventDefault();
  const status = document.getElementById("status-filter").value;
  const type = document.getElementById("command-filter").value;
  const params = new URLSearchParams();
  if (status) params.append("status", status);
  if (type) params.append("command_type", type);
  window.location = `/guilds/{{ guild_id }}/history?${params.toString()}`;
});

function expandRow(row) {
  const next = row.nextElementSibling;
  if (next && next.classList.contains("details-row")) {
    if (next.style.display === "none") {
      next.style.display = "table-row";
    } else {
      next.style.display = "none";
    }
  }
}

async function deleteMessage(messageId) {
  if (!confirm("Are you sure you want to delete this message from Discord? The database record will be kept for history.")) {
    return;
  }

  try {
    const response = await fetch(`/api/messages/${messageId}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
      },
    });

    if (!response.ok) {
      const error = await response.json();
      alert(`Failed to delete message: ${error.detail || "Unknown error"}`);
      return;
    }

    alert("Message deleted from Discord successfully!");
    // Reload the page to reflect the deletion
    window.location.reload();
  } catch (error) {
    alert(`Error deleting message: ${error.message}`);
  }
}
</script>
{% endblock %}