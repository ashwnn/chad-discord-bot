{% extends "base.html" %}
{% block title %}History - Grok Discord Bot Admin{% endblock %}

{% block content %}
<div class="page-header">
  <h2>Message History</h2>
  <p class="page-subtitle">View and search all processed requests</p>
</div>

<div class="card filter-card">
  <h3>Filters</h3>
  <form id="filter-form" class="filter-form">
    <div class="filter-group">
      <label for="status-filter">Status</label>
      <select name="status" id="status-filter">
        <option value="">All Status</option>
        <option value="auto_responded" {% if status_filter == 'auto_responded' %}selected{% endif %}>Auto Responded</option>
        <option value="pending_approval" {% if status_filter == 'pending_approval' %}selected{% endif %}>Pending</option>
        <option value="approved_grok" {% if status_filter == 'approved_grok' %}selected{% endif %}>Approved (Grok)</option>
        <option value="approved_manual" {% if status_filter == 'approved_manual' %}selected{% endif %}>Approved (Manual)</option>
        <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
        <option value="error" {% if status_filter == 'error' %}selected{% endif %}>Error</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label for="command-filter">Type</label>
      <select name="command_type" id="command-filter">
        <option value="">All Types</option>
        <option value="ask" {% if command_type_filter == 'ask' %}selected{% endif %}>Chat (/ask)</option>
      </select>
    </div>
    
    <button type="submit" class="btn btn-filter">Apply Filters</button>
  </form>
</div>

{% if history | length > 0 %}
<div class="card">
  <table class="table history-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>User</th>
        <th>Type</th>
        <th>Status</th>
        <th>Tokens</th>
        <th>Cost</th>
        <th>Content</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for row in history %}
      <tr class="history-row" style="cursor: pointer;" onclick="expandRow(this)">
        <td class="text-sm muted">{{ row.created_at | truncate(16, True, '') }}</td>
        <td class="text-sm">{{ row.user_id }}</td>
        <td>
          {% if row.command_type == 'ask' %}
          <span class="pill">Chat</span>
          {% else %}
          <span class="pill">{{ row.command_type }}</span>
          {% endif %}
        </td>
        <td>
          {% if row.status == 'auto_responded' %}
          <span class="pill">Responded</span>
          {% elif row.status == 'approved_grok' %}
          <span class="pill success">Approved</span>
          {% elif row.status == 'approved_manual' %}
          <span class="pill success">Manual</span>
          {% elif row.status == 'rejected' %}
          <span class="pill danger">Rejected</span>
          {% elif row.status == 'pending_approval' %}
          <span class="pill warning">Pending</span>
          {% elif row.status == 'error' %}
          <span class="pill danger">Error</span>
          {% else %}
          <span class="pill">{{ row.status }}</span>
          {% endif %}
        </td>
        <td class="text-sm">{{ row.total_tokens or '-' }}</td>
        <td class="text-sm">{{ ('$%.4f'|format(row.estimated_cost_usd)) if row.estimated_cost_usd else '-' }}</td>
        <td class="text-sm preview-cell">{{ row.user_content[:60] }}</td>
        <td class="text-sm actions-cell" onclick="event.stopPropagation();">
          {% if not row.deleted_at %}
          <button class="btn-delete" onclick="deleteMessage({{ row.id }})">Delete</button>
          {% else %}
          <span class="text-muted text-sm">Deleted</span>
          {% endif %}
        </td>
      </tr>
      <tr class="details-row" style="display: none;">
        <td colspan="7">
          <div class="details-panel">
            <div class="details-grid">
              <div class="detail-section">
                <h4>Request Content</h4>
                <p class="detail-text">{{ row.user_content }}</p>
              </div>
              {% if row.grok_response_content %}
              <div class="detail-section">
                <h4>Bot Reply</h4>
                <p class="detail-text bot-reply">{{ row.grok_response_content }}</p>
              </div>
              {% endif %}
              <div class="detail-section">
                <h4>Metadata</h4>
                <dl class="detail-list">
                  <dt>Request ID:</dt>
                  <dd>{{ row.id }}</dd>
                  <dt>Status:</dt>
                  <dd>{{ row.status }}</dd>
                  <dt>Decision:</dt>
                  <dd>{{ row.decision or 'N/A' }}</dd>
                  <dt>Tokens Used:</dt>
                  <dd>{{ row.total_tokens or 'N/A' }}</dd>
                </dl>
              </div>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="card empty-state">
  <p class="muted text-center">No history found</p>
</div>
{% endif %}

<style>
  /* This embedded style block has been updated to use the CSS variables 
    from the style-guide.md (defined in style.css).
  */

  .page-header {
    margin-bottom: 32px;
  }

  .page-header h2 {
    margin: 0 0 8px 0;
    font-size: 2rem;
    font-weight: 600; /* from guide */
    letter-spacing: -0.025em; /* from guide */
  }

  .page-subtitle {
    margin: 0;
    color: var(--color-text-muted);
    font-size: 1.125rem; /* from guide */
  }

  .filter-card h3 {
    margin-top: 0;
    margin-bottom: 16px;
    font-size: 1.125rem; /* 18px */
    font-weight: 600; /* from guide */
  }

  .filter-form {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    align-items: flex-end;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .filter-group label {
    font-weight: 500;
    font-size: 0.875rem;
  }

  /* Re-themed select to match guide's input fields */
  .filter-group select {
    padding: 8px 12px;
    border: 1px solid var(--color-border-interactive);
    border-radius: 0.375rem; /* 6px */
    font-size: 0.875rem;
    background: var(--color-bg-base);
  }

  /* Re-themed custom button to match guide's primary button */
  .btn-filter {
    padding: 8px 16px;
    background: rgb(var(--color-blue-600) / 1);
    color: var(--color-white);
    border: none;
    border-radius: 0.375rem; /* 6px */
    font-weight: 500;
    cursor: pointer;
    font-size: 0.875rem;
    box-shadow: var(--shadow-button);
  }

  .btn-filter:hover {
    background: rgb(var(--color-blue-500) / 1);
    box-shadow: var(--shadow-md);
  }

  .table {
    width: 100%;
    border-collapse: collapse;
  }

  .table thead th {
    text-align: left;
    padding: 12px;
    border-bottom: 1px solid var(--color-border-base); /* Changed to 1px for subtlety */
    font-weight: 600;
    font-size: 0.75rem; /* 12px */
    color: var(--color-text-muted);
    text-transform: uppercase; /* from guide */
    letter-spacing: 0.05em; /* from guide */
  }

  .history-table tbody td {
    padding: 12px;
    border-bottom: 1px solid var(--color-border-base);
  }

  .history-row:hover {
    background: var(--color-bg-menu-item-hover);
  }

  .preview-cell {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .text-sm {
    font-size: 0.75rem; /* 12px (from guide) */
  }

  .muted {
    color: var(--color-text-muted);
  }

  .text-center {
    text-align: center;
  }

  .details-row {
    background: var(--color-bg-app);
  }

  .details-panel {
    padding: 20px;
    border-radius: 0.375rem; /* 6px */
  }

  .details-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
  }

  @media (min-width: 768px) {
    .details-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .detail-section h4 {
    margin: 0 0 12px 0;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .detail-text {
    margin: 0;
    padding: 12px;
    background: var(--color-bg-base);
    border-radius: 0.25rem; /* 4px */
    border-left: 3px solid rgb(var(--color-blue-500) / 1);
    white-space: pre-wrap;
    word-break: break-word;
    /* Using guide's monospace font stack */
    font-family: SFMono-Regular, SFMono Regular, Consolas, Liberation Mono, Menlo,
      Courier, monospace;
    font-size: 0.8125rem; /* 13px (from guide) */
  }

  .detail-text.bot-reply {
    border-left-color: rgb(var(--color-green-300) / 1); /* Was #10b981 */
    background: rgb(var(--color-green-0) / 1); /* Was #f0fdf4 */
  }

  .detail-list {
    margin: 0;
    padding: 0;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 12px 16px;
  }

  .detail-list dt {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }

  .detail-list dd {
    margin: 0;
    font-size: 0.9rem;
    word-break: break-all;
  }

  .empty-state {
    text-align: center;
    padding: 48px 24px;
  }

  .actions-cell {
    white-space: nowrap;
  }

  /* Re-themed custom delete button */
  .btn-delete {
    padding: 4px 12px;
    background: rgb(var(--color-red-600) / 1); /* Was var(--color-red-500) */
    color: var(--color-white);
    border: none;
    border-radius: 0.375rem; /* 6px */
    font-weight: 500;
    cursor: pointer;
    font-size: 0.75rem;
    transition: background 0.2s ease;
    box-shadow: var(--shadow-button);
  }

  .btn-delete:hover {
    background: rgb(var(--color-red-500) / 1); /* Was var(--color-red-600) */
    box-shadow: var(--shadow-md);
  }

  .text-muted {
    color: var(--color-text-muted);
  }

  @media (max-width: 768px) {
    .filter-form {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-group {
      width: 100%;
    }
  }
</style>

<script>
document.getElementById("filter-form").addEventListener("submit", (e) => {
  e.preventDefault();
  const status = document.getElementById("status-filter").value;
  const type = document.getElementById("command-filter").value;
  const params = new URLSearchParams();
  if (status) params.append("status", status);
  if (type) params.append("command_type", type);
  window.location = `/guilds/{{ guild_id }}/history?${params.toString()}`;
});

function expandRow(row) {
  const next = row.nextElementSibling;
  if (next && next.classList.contains("details-row")) {
    if (next.style.display === "none") {
      next.style.display = "table-row";
    } else {
      next.style.display = "none";
    }
  }
}

async function deleteMessage(messageId) {
  if (!confirm("Are you sure you want to delete this message from Discord? The database record will be kept for history.")) {
    return;
  }

  try {
    const response = await fetch(`/api/messages/${messageId}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
      },
    });

    if (!response.ok) {
      const error = await response.json();
      alert(`Failed to delete message: ${error.detail || "Unknown error"}`);
      return;
    }

    alert("Message deleted from Discord successfully!");
    // Reload the page to reflect the deletion
    window.location.reload();
  } catch (error) {
    alert(`Error deleting message: ${error.message}`);
  }
}
</script>
{% endblock %}