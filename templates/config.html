{% extends "base.html" %}
{% block title %}Configuration - Grok Discord Bot Admin{% endblock %}

{% block content %}
<div class="page-header">
  <h2>Configuration</h2>
  <p class="page-subtitle">Edit bot behavior, limits, and system prompt</p>
</div>

<form id="config-form" class="card">
  <section class="form-section">
    <div class="section-header">
      <h3>Rate Limits</h3>
      <p class="section-description">How frequently users can issue commands per time window</p>
    </div>
    
    <div class="grid grid-cols-2">
      <div class="form-group">
        <label for="ask_window_seconds">/ask Window (seconds)</label>
        <input type="number" id="ask_window_seconds" name="ask_window_seconds" value="{{ config.ask_window_seconds }}" min="1" required>
      </div>
      <div class="form-group">
        <label for="ask_max_per_window">/ask Max per Window</label>
        <input type="number" id="ask_max_per_window" name="ask_max_per_window" value="{{ config.ask_max_per_window }}" min="1" required>
      </div>
    </div>

    <div class="form-group">
      <label for="duplicate_window_seconds">Duplicate Check Window (seconds)</label>
      <input type="number" id="duplicate_window_seconds" name="duplicate_window_seconds" value="{{ config.duplicate_window_seconds }}" min="1" required>
    </div>
  </section>

  <hr class="section-divider">

  <section class="form-section">
    <div class="section-header">
      <h3>Daily Budgets</h3>
      <p class="section-description">Token and image limits reset daily at midnight UTC</p>
    </div>

    <div class="grid grid-cols-2">
      <div class="form-group">
        <label for="user_daily_chat_token_limit">User Daily Chat Token Limit</label>
        <input type="number" id="user_daily_chat_token_limit" name="user_daily_chat_token_limit" value="{{ config.user_daily_chat_token_limit }}" min="0" required>
      </div>
      <div class="form-group">
        <label for="global_daily_chat_token_limit">Guild Daily Chat Token Limit</label>
        <input type="number" id="global_daily_chat_token_limit" name="global_daily_chat_token_limit" value="{{ config.global_daily_chat_token_limit }}" min="0" required>
      </div>
    </div>
  </section>

  <hr class="section-divider">

  <section class="form-section">
    <div class="section-header">
      <h3>Auto Approval</h3>
      <p class="section-description">Require admin approval before calling Grok</p>
    </div>

    <div class="form-group">
      <label class="toggle">
        <label class="toggle-switch">
          <input type="checkbox" id="auto_approve_enabled" name="auto_approve_enabled" {% if config.auto_approve_enabled %}checked{% endif %}>
          <span class="toggle-slider"></span>
        </label>
        <span>Enable auto-approve queue</span>
      </label>
    </div>

    <div class="form-group">
      <label class="toggle">
        <label class="toggle-switch">
          <input type="checkbox" id="admin_bypass_auto_approve" name="admin_bypass_auto_approve" {% if config.admin_bypass_auto_approve %}checked{% endif %}>
          <span class="toggle-slider"></span>
        </label>
        <span>Admins bypass auto-approve</span>
      </label>
    </div>

    <div class="form-group">
      <label for="admin_user_ids">Administrator Discord IDs</label>
      <input type="text" id="admin_user_ids" name="admin_user_ids" value="{{ config.admin_user_ids or '' }}" placeholder="e.g., 123456789,987654321">
      <p class="form-hint">Comma-separated Discord user IDs that can approve requests</p>
    </div>
  </section>

  <hr class="section-divider">

  <section class="form-section">
    <div class="section-header">
      <h3>Grok Model Settings</h3>
      <p class="section-description">Configure model behavior and output</p>
    </div>

    <div class="grid grid-cols-2">
      <div class="form-group">
        <label for="temperature">Temperature (0.0 - 2.0)</label>
        <input type="number" id="temperature" name="temperature" value="{{ config.temperature }}" min="0" max="2" step="0.1" required>
        <p class="form-hint">Lower = more focused and deterministic, Higher = more creative and diverse</p>
      </div>
      <div class="form-group">
        <label for="max_completion_tokens">Max Completion Tokens</label>
        <input type="number" id="max_completion_tokens" name="max_completion_tokens" value="{{ config.max_completion_tokens }}" min="1" required>
        <p class="form-hint">Maximum tokens for each response</p>
      </div>
    </div>

    <div class="form-group">
      <label for="max_prompt_chars">Max Prompt Characters</label>
      <input type="number" id="max_prompt_chars" name="max_prompt_chars" value="{{ config.max_prompt_chars }}" min="1" required>
    </div>
  </section>

  <hr class="section-divider">

  <section class="form-section">
    <div class="section-header">
      <h3>Guild System Prompt</h3>
      <p class="section-description">Per-guild instructions for bot personality and behavior. Leave empty to use global default from Messages configuration. Avoid slurs, explicit content, and graphic violence.</p>
    </div>

    <div class="form-group">
      <textarea id="system_prompt" name="system_prompt"></textarea>
      <p class="form-hint">This guild-specific system prompt overrides the global system prompt. Clear this field to use the global default.</p>
    </div>
  </section>

  <div class="form-actions">
    <button type="submit" class="btn">Save Configuration</button>
    <div id="config-status" class="muted"></div>
  </div>
</form>

<script>
const guildId = "{{ guild_id }}";

// Load system prompt on page load
document.addEventListener('DOMContentLoaded', async () => {
  const promptTextarea = document.getElementById('system_prompt');
  const currentPrompt = {{ config.system_prompt | tojson }};
  promptTextarea.value = currentPrompt;
});

document.getElementById("config-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  const payload = {};
  
  // Define which fields should be numeric
  const numericFields = [
    'ask_window_seconds', 'ask_max_per_window', 'image_window_seconds',
    'image_max_per_window', 'duplicate_window_seconds', 'user_daily_chat_token_limit',
    'global_daily_chat_token_limit', 'user_daily_image_limit', 'global_daily_image_limit',
    'temperature', 'max_completion_tokens', 'max_prompt_chars'
  ];
  
  // Process all form fields
  for (const [key, value] of formData.entries()) {
    if (key === "auto_approve_enabled" || key === "admin_bypass_auto_approve") {
      payload[key] = true;
    } else if (numericFields.includes(key) && value !== "") {
      payload[key] = Number(value);
    } else {
      payload[key] = value;
    }
  }
  
  // Explicitly set unchecked checkboxes to false
  const checkboxes = e.target.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(checkbox => {
    if (!(checkbox.name in payload)) {
      payload[checkbox.name] = false;
    }
  });

  const res = await fetch(`/api/guilds/${guildId}/config`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload),
  });

  const status = document.getElementById("config-status");
  if (res.ok) {
    status.textContent = "Configuration saved";
    status.style.color = "var(--color-text-success)";
    console.log("Configuration saved successfully");
  } else {
    let errorMessage = "Error saving configuration";
    try {
      const errorData = await res.json();
      if (errorData.detail) {
        errorMessage = `Error: ${errorData.detail}`;
      }
    } catch (e) {
      // Could not parse error response
    }
    status.textContent = errorMessage;
    status.style.color = "var(--color-text-danger)";
    console.error("Failed to save configuration:", errorMessage);
  }
  setTimeout(() => { status.textContent = ""; }, 3000);
});
</script>
{% endblock %}
