{% extends "base.html" %}
{% block title %}Approval Queue - Grok Discord Bot Admin{% endblock %}

{% block content %}
<div class="page-header">
  <h2>Approval Queue</h2>
  <p class="page-subtitle">Review and approve pending requests</p>
</div>

{% if pending | length == 0 %}
<div class="card empty-state">
  <p class="muted text-center">No pending approvals</p>
</div>
{% else %}
<div class="queue-info">
  <p><strong>{{ pending | length }}</strong> pending request{{ 's' if pending | length != 1 else '' }}</p>
</div>

<div class="card">
  <table class="table queue-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>User</th>
        <th>Type</th>
        <th>Preview</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for item in pending %}
      <tr class="queue-row" data-id="{{ item.id }}">
        <td class="text-sm muted">{{ item.created_at | truncate(16, True, '') }}</td>
        <td class="text-sm">{{ item.user_id }}</td>
        <td>
          {% if item.command_type == 'ask' %}
          <span class="pill">Chat</span>
          {% else %}
          <span class="pill">{{ item.command_type }}</span>
          {% endif %}
        </td>
        <td class="text-sm preview-cell">{{ item.user_content[:80] }}</td>
        <td>
          <button class="btn-link" onclick="expandItem(this)">Details</button>
        </td>
      </tr>
      <tr class="details-row" style="display: none;">
        <td colspan="5">
          <div class="details-panel">
            <div class="request-content">
              <h4>Full Request</h4>
              <p class="content-text">{{ item.user_content }}</p>
            </div>
            
            <div class="action-buttons">
              <button class="btn btn-success" onclick="approve({{ item.id }}, 'grok')">Approve via Grok</button>
              <button class="btn secondary" onclick="manual({{ item.id }})">Manual Reply</button>
              <button class="btn danger" onclick="reject({{ item.id }})">Reject</button>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<script>
function expandItem(button) {
  const row = button.closest('tr');
  const detailsRow = row.nextElementSibling;
  
  if (detailsRow && detailsRow.classList.contains('details-row')) {
    if (detailsRow.style.display === 'none') {
      detailsRow.style.display = 'table-row';
      button.textContent = 'Hide';
    } else {
      detailsRow.style.display = 'none';
      button.textContent = 'Details';
    }
  }
}

async function approve(id, decision) {
  const body = { decision };
  
  if (decision === "reject") {
    body.reason = prompt("Reason for rejection (optional):") || undefined;
  }
  
  if (decision === "manual") {
    body.manual_reply_content = prompt("Enter your manual reply:") || "";
    if (!body.manual_reply_content) {
      alert("Manual reply cannot be empty");
      return;
    }
  }

  try {
    const res = await fetch(`/api/approvals/${id}`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(body),
    });
    
    if (res.ok) {
      location.reload();
    } else {
      const error = await res.json();
      alert(`Error: ${error.detail || 'Failed to process approval'}`);
    }
  } catch (err) {
    alert(`Error: ${err.message}`);
  }
}

function reject(id) { approve(id, "reject"); }
function manual(id) { approve(id, "manual"); }
</script>
{% endblock %}