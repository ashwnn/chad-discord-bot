{% extends "base.html" %}
{% block title %}Approval Queue - Grok Discord Bot Admin{% endblock %}

{% block content %}
<div class="page-header">
  <h2>Approval Queue</h2>
  <p class="page-subtitle">Review and approve pending requests</p>
</div>

{% if pending | length == 0 %}
<div class="card empty-state">
  <p class="muted text-center">No pending approvals</p>
</div>
{% else %}
<div class="queue-info">
  <p><strong>{{ pending | length }}</strong> pending request{{ 's' if pending | length != 1 else '' }}</p>
</div>

<div class="card">
  <table class="table queue-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>User</th>
        <th>Type</th>
        <th>Preview</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for item in pending %}
      <tr class="queue-row" data-id="{{ item.id }}">
        <td class="text-sm muted">{{ item.created_at | truncate(16, True, '') }}</td>
        <td class="text-sm">{{ item.user_id }}</td>
        <td>
          {% if item.command_type == 'ask' %}
          <span class="pill">Chat</span>
          {% else %}
          <span class="pill">{{ item.command_type }}</span>
          {% endif %}
        </td>
        <td class="text-sm preview-cell">{{ item.user_content[:80] }}</td>
        <td>
          <button class="btn-link" onclick="expandItem(this)">Details</button>
        </td>
      </tr>
      <tr class="details-row" style="display: none;">
        <td colspan="5">
          <div class="details-panel">
            <div class="request-content">
              <h4>Full Request</h4>
              <p class="content-text">{{ item.user_content }}</p>
            </div>
            
            <div class="action-buttons">
              <button class="btn btn-success" onclick="approve({{ item.id }}, 'grok')">Approve via Grok</button>
              <button class="btn secondary" onclick="manual({{ item.id }})">Manual Reply</button>
              <button class="btn danger" onclick="reject({{ item.id }})">Reject</button>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<style>
  .page-header {
    margin-bottom: 2rem; /* 32px */
  }

  .page-header h2 {
    margin: 0 0 0.5rem 0; /* 8px */
    font-size: 2rem; /* 32px */
    font-weight: 600;
    letter-spacing: -0.025em;
  }

  .page-subtitle {
    margin: 0;
    color: var(--color-text-muted);
    font-size: 1rem; /* 16px */
  }

  .queue-info {
    margin-bottom: 1.25rem; /* 20px */
    padding: 0.75rem 1rem; /* 12px 16px */
    background: var(--color-bg-app);
    border-radius: 0.375rem; /* 6px */
  }

  .queue-info p {
    margin: 0;
    font-size: 0.875rem; /* 14px */
  }

  .queue-info strong {
    font-weight: 600;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1.5rem; /* 48px 24px */
  }

  .table {
    width: 100%;
    border-collapse: collapse;
  }

  .table thead th {
    text-align: left;
    padding: 0.75rem; /* 12px */
    border-bottom: 1px solid var(--color-border-base);
    font-weight: 600;
    font-size: 0.75rem; /* 12px */
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .queue-table tbody td {
    padding: 0.75rem; /* 12px */
    border-bottom: 1px solid var(--color-border-base);
  }

  .queue-row:hover {
    background: var(--color-bg-app);
  }

  .preview-cell {
    max-width: 15.625rem; /* 250px */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .text-sm {
    font-size: 0.75rem; /* 12px */
  }

  .muted {
    color: var(--color-text-muted);
  }

  .text-center {
    text-align: center;
  }

  .btn-link {
    background: none;
    border: none;
    color: var(--color-text-primary);
    cursor: pointer;
    font-weight: 500;
    padding: 0;
    font-size: 0.875rem; /* 14px */
    text-decoration: none;
  }

  .btn-link:hover {
    text-decoration: underline;
  }

  .details-row {
    background: var(--color-bg-app);
  }

  .details-panel {
    padding: 1.25rem; /* 20px */
  }

  .request-content h4 {
    margin: 0 0 0.75rem 0; /* 12px */
    font-size: 1rem; /* 16px */
    font-weight: 600;
  }

  .content-text {
    margin: 0;
    padding: 0.75rem; /* 12px */
    background: var(--color-bg-base);
    border-radius: 0.25rem; /* 4px */
    border-left: 3px solid rgb(var(--color-blue-500) / 1);
    white-space: pre-wrap;
    word-break: break-word;
    font-family: "SFMono-Regular", "SFMono Regular", "Consolas",
      "Liberation Mono", "Menlo", "Courier", monospace;
    font-size: 0.8125rem; /* 13px */
  }

  .action-buttons {
    display: flex;
    gap: 0.5rem; /* 8px */
    margin-top: 1rem; /* 16px */
    flex-wrap: wrap;
  }

  /* Redundant .btn, .btn-success, .btn-secondary, 
    and .btn-danger styles were removed from here.
    They are now correctly handled by the main style.css 
    file, which implements the style-guide.md tokens.
  */
</style>

<script>
function expandItem(button) {
  const row = button.closest('tr');
  const detailsRow = row.nextElementSibling;
  
  if (detailsRow && detailsRow.classList.contains('details-row')) {
    if (detailsRow.style.display === 'none') {
      detailsRow.style.display = 'table-row';
      button.textContent = 'Hide';
    } else {
      detailsRow.style.display = 'none';
      button.textContent = 'Details';
    }
  }
}

async function approve(id, decision) {
  const body = { decision };
  
  if (decision === "reject") {
    body.reason = prompt("Reason for rejection (optional):") || undefined;
  }
  
  if (decision === "manual") {
    body.manual_reply_content = prompt("Enter your manual reply:") || "";
    if (!body.manual_reply_content) {
      alert("Manual reply cannot be empty");
      return;
    }
  }

  try {
    const res = await fetch(`/api/approvals/${id}`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(body),
    });
    
    if (res.ok) {
      location.reload();
    } else {
      const error = await res.json();
      alert(`Error: ${error.detail || 'Failed to process approval'}`);
    }
  } catch (err) {
    alert(`Error: ${err.message}`);
  }
}

function reject(id) { approve(id, "reject"); }
function manual(id) { approve(id, "manual"); }
</script>
{% endblock %}