{% extends "base.html" %}
{% block title %}Analytics - Grok Discord Bot Admin{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
  <h2>Analytics</h2>
  <p class="page-subtitle">Guild usage and request breakdown</p>
</div>

<div class="grid grid-cols-3">
  <div class="card stat-card">
    <p class="stat-label">Total Requests</p>
    <p class="stat-value">{{ analytics.status_counts.values() | sum | default(0) }}</p>
    <p class="stat-subtitle">All time</p>
  </div>

  <div class="card stat-card">
    <p class="stat-label">Tokens Used</p>
    <p class="stat-value">{{ analytics.token_total | default(0) }}</p>
    <p class="stat-subtitle">Chat token consumption</p>
  </div>

  <div class="card stat-card">
    <p class="stat-label">Estimated Cost</p>
    <p class="stat-value">${{ "%.4f"|format(analytics.total_cost_usd) }}</p>
  <p class="stat-subtitle">Total API usage ({{ model_pricing.model }}: ${{ "%.2f"|format(model_pricing.prompt) }} / ${{ "%.2f"|format(model_pricing.completion) }} per M tokens)</p>
  </div>
</div>

<div class="grid grid-cols-2">
  <div class="card">
    <h3>Request Status Breakdown</h3>
    <canvas id="statusChart" style="max-height: 300px;"></canvas>
  </div>

  <div class="card">
    <h3>Status Summary</h3>
    <div class="status-list">
      {% set statuses = [
        ('auto_responded', 'Auto Responded', '--color-blue-500'),
        ('approved_grok', 'Approved via Grok', '--color-text-success'),
        ('approved_manual', 'Approved Manually', '--color-green-300'),
        ('rejected', 'Rejected', '--color-text-danger'),
        ('pending_approval', 'Pending Review', '--color-text-warning'),
        ('error', 'Errors', '--color-red-400')
      ] %}
      {% for key, label, color_var_name in statuses %}
      <div class="status-row" data-color-var="{{ color_var_name }}">
        <div class="status-indicator" style="background-color: rgb(var({{ color_var_name }}) / 1);"></div>
        <span class="status-label">{{ label }}</span>
        <strong class="status-count">{{ analytics.status_counts.get(key, 0) }}</strong>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Status breakdown chart
  const ctx = document.getElementById('statusChart').getContext('2d');
  const statusLabels = [
    'Auto Responded',
    'Approved (Grok)',
    'Approved (Manual)',
    'Rejected',
    'Pending Review',
    'Errors'
  ];
  const statusData = [
    {{ analytics.status_counts.get('auto_responded', 0) }},
    {{ analytics.status_counts.get('approved_grok', 0) }},
    {{ analytics.status_counts.get('approved_manual', 0) }},
    {{ analytics.status_counts.get('rejected', 0) }},
    {{ analytics.status_counts.get('pending_approval', 0) }},
    {{ analytics.status_counts.get('error', 0) }}
  ];

  // Read computed colors from the DOM to support light/dark mode
  const computedStyles = getComputedStyle(document.documentElement);
  const statusColors = Array.from(document.querySelectorAll('.status-row[data-color-var]'))
    .map(row => {
      const varName = row.dataset.colorVar;
      // The style guide uses RGB components, so we read the variable
      // and construct the rgb() string for the computed style.
      const rgbValue = computedStyles.getPropertyValue(varName).trim();
      return `rgb(${rgbValue})`;
    });

  // Get computed colors for chart text and borders
  const chartBorderColor = `rgb(${computedStyles.getPropertyValue('--color-bg-base').trim()})`;
  const chartTextColor = `rgb(${computedStyles.getPropertyValue('--color-text-muted').trim()})`;
  const chartFontFamily = computedStyles.getPropertyValue('font-family') || "'Inter', sans-serif";

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{
        data: statusData,
        backgroundColor: statusColors.length > 0 ? statusColors : [
          // Fallback colors just in case JS fails
          '#2563eb',
          '#16a34a',
          '#10b981',
          '#dc2626',
          '#f59e0b',
          '#ef4444'
        ],
        borderColor: chartBorderColor,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: chartTextColor,
            font: {
              size: 12,
              family: chartFontFamily
            },
            padding: 15
          }
        }
      }
    }
  });
});
</script>
{% endblock %}